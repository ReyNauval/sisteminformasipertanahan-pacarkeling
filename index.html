<script>
/* ================= MAP ================= */
const map = L.map('map').setView([-7.2499,112.7532],15);

/* ================= BASEMAP ================= */
const basemaps={
 osm:L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png'),
 carto:L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png'),
 esri:L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}')
};
basemaps.osm.addTo(map);

/* ================= ELEMENT ================= */
const layerPersil  = document.getElementById("layerPersil");
const layerBangunan= document.getElementById("layerBangunan");
const layerJalan   = document.getElementById("layerJalan");
const layerKereta  = document.getElementById("layerKereta");
const layerBatas   = document.getElementById("layerBatas");

/* ================= COLOR ================= */
const palette=["#FFD700","#FF6B6B","#90EE90","#87CEEB","#DDA0DD"];
let colorMap={};
function getColor(j){
 if(!colorMap[j]) colorMap[j]=palette[Object.keys(colorMap).length%palette.length];
 return colorMap[j];
}

/* ================= HIGHLIGHT ================= */
let activeLayer=null;
function highlight(l){
 if(activeLayer) persilLayer.resetStyle(activeLayer);
 l.setStyle({weight:4,color:'#000',fillOpacity:.9});
 map.fitBounds(l.getBounds());
 activeLayer=l;
}

/* ================= PATH ================= */
const PATH="geojson/";

/* ================= LAYERS ================= */
let persilLayer,bangunanLayer,jalanLayer,keretaLayer,batasLayer;

/* ================= PERSIL ================= */
fetch(PATH+"persil.geojson")
.then(r=>{
 if(!r.ok) throw new Error("persil.geojson tidak ditemukan");
 return r.json();
})
.then(data=>{
 persilLayer=L.geoJSON(data,{
  style:f=>({
   fillColor:getColor(f.properties.JENIS),
   color:'#333',weight:1,fillOpacity:.7
  }),
  onEachFeature:(f,l)=>{
   let html="";
   for(let k in f.properties){
    html+=`<b>${k}</b>: ${f.properties[k]}<br>`;
   }
   l.bindPopup(html);
   l.on('click',()=>highlight(l));
  }
 }).addTo(map);

 bangunanLayer=L.geoJSON(data,{
  filter:f=>f.properties.JENIS==="building",
  style:{fillColor:"#FF6B6B",color:"#8B0000",weight:2,fillOpacity:.8}
 });

 document.getElementById("totalBidang").innerText=data.features.length;
 buildLegend(data);
});

/* ================= JALAN ================= */
fetch(PATH+"jalan.geojson")
.then(r=>r.json())
.then(d=>{
 jalanLayer=L.geoJSON(d,{style:{color:"#000",weight:4}}).addTo(map);
});

/* ================= KERETA ================= */
fetch(PATH+"kereta.geojson")
.then(r=>r.json())
.then(d=>{
 keretaLayer=L.geoJSON(d,{style:{color:"blue",weight:3,dashArray:"8,4"}}).addTo(map);
});

/* ================= BATAS ================= */
fetch(PATH+"batas.geojson")
.then(r=>r.json())
.then(d=>{
 batasLayer=L.geoJSON(d,{style:{color:"red",weight:4,fillOpacity:0}}).addTo(map);
});

/* ================= TOGGLE ================= */
layerPersil.onchange = e => {
 if(!persilLayer) return;
 e.target.checked ? map.addLayer(persilLayer) : map.removeLayer(persilLayer);
};
layerBangunan.onchange = e => {
 if(!bangunanLayer) return;
 e.target.checked ? map.addLayer(bangunanLayer) : map.removeLayer(bangunanLayer);
};
layerJalan.onchange = e => {
 if(!jalanLayer) return;
 e.target.checked ? map.addLayer(jalanLayer) : map.removeLayer(jalanLayer);
};
layerKereta.onchange = e => {
 if(!keretaLayer) return;
 e.target.checked ? map.addLayer(keretaLayer) : map.removeLayer(keretaLayer);
};
layerBatas.onchange = e => {
 if(!batasLayer) return;
 e.target.checked ? map.addLayer(batasLayer) : map.removeLayer(batasLayer);
};

/* ================= BASEMAP SWITCH ================= */
document.querySelectorAll('input[name=basemap]').forEach(r=>{
 r.onchange=()=>{
  Object.values(basemaps).forEach(b=>map.removeLayer(b));
  basemaps[r.value].addTo(map);
 };
});

/* ================= LEGEND ================= */
function buildLegend(data){
 const legend=document.getElementById("legendContent");
 legend.innerHTML="";
 [...new Set(data.features.map(f=>f.properties.JENIS))].forEach(j=>{
  legend.innerHTML+=`
   <div class="legend-item">
    <div class="legend-symbol" style="background:${getColor(j)}"></div>
    ${j.toUpperCase()}
   </div>`;
 });
}
</script>
