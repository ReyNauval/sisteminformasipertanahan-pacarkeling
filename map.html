<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Peta Informasi Pertanahan</title>

<!-- Leaflet -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css"/>

<!-- Leaflet Draw -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css"/>

<!-- Google Material Icons -->
<link href="https://fonts.googleapis.com/css2?family=Material+Icons" rel="stylesheet">

<style>
*{margin:0;padding:0;box-sizing:border-box}
html,body{height:100%}
body{font-family:Segoe UI,Tahoma,sans-serif}
#map{height:100%}

/* NAV */
.nav-home{
 position:absolute;top:15px;left:15px;
 background:linear-gradient(45deg,#ff9800,#ff5722);
 color:#fff;padding:6px 14px;border-radius:20px;
 text-decoration:none;font-size:13px;z-index:1200
}

/* HEADER */
.header {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  background: linear-gradient(to right, #1c4e1f, #08ec13);
  color: #fff;
  padding: 12px;
  z-index: 1000;
  text-align: center;
}
.header-title{font-weight:600;line-height:1.3}

/* TOOLBAR */
.map-toolbar{
 position:absolute;top:90px;left:10px;
 display:flex;flex-direction:column;gap:6px;z-index:1100
}
.tool-btn{
 background:#fff;border:none;border-radius:6px;
 padding:6px;cursor:pointer;
 box-shadow:0 2px 6px rgba(0,0,0,.3);
 transition: background-color 0.3s;
}
.tool-btn:hover{
 background:#f0f0f0;
}
.tool-btn.active{
 background:#e0e0e0;
}
.tool-btn span{font-size:20px}

/* MEASURE TOOLBAR */
.measure-toolbar{
 position:absolute;top:90px;left:60px;
 display:none;flex-direction:column;gap:6px;z-index:1095;
 background:#fff;padding:8px;border-radius:8px;
 box-shadow:0 2px 10px rgba(0,0,0,.3);
}
.measure-toolbar.active{
 display:flex;
}
.measure-btn{
 background:#f8f9fa;border:1px solid #dee2e6;border-radius:4px;
 padding:8px 12px;cursor:pointer;font-size:12px;
 display:flex;align-items:center;gap:6px;
 transition: all 0.2s;
}
.measure-btn:hover{
 background:#e9ecef;
}
.measure-btn.active{
 background:#007bff;color:#fff;border-color:#007bff;
}
.measure-btn span{font-size:18px}
.measure-divider{
 height:1px;background:#dee2e6;margin:4px 0;
}
.measure-result{
 background:#f8f9fa;padding:6px 8px;border-radius:4px;
 font-size:11px;color:#495057;text-align:center;
 display:none;
}
.measure-result.show{
 display:block;
}

/* PANEL */
.panel{
 display:none;position:absolute;top:90px;left:60px;
 background:#fff;padding:10px;border-radius:8px;
 box-shadow:0 2px 10px rgba(0,0,0,.3);z-index:1090;
 font-size:13px
}

/* INFO */
.info-box{
 position:absolute;bottom:20px;left:20px;
 background:#fff;padding:10px;border-radius:8px;
 font-size:12px;z-index:1100
}

/* FOOTER */
.map-footer{
 position:absolute;bottom:10px;right:10px;
 background:#fff;padding:6px 10px;border-radius:6px;
 font-size:11px;z-index:1100
}

/* NORTH */
.north-arrow{
 position:absolute;bottom:90px;right:20px;
 background:#fff;padding:10px;border-radius:50%;
 box-shadow:0 2px 6px rgba(0,0,0,.3);z-index:1100;
 width:50px;height:50px;
 display:flex;align-items:center;justify-content:center;
}
.north-arrow svg{
 width:30px;height:30px;
}

/* LEGEND */
.legend-item{display:flex;align-items:center;margin-bottom:4px}
.legend-symbol{
 width:20px;height:12px;margin-right:6px;border:1px solid #555
}
</style>
</head>

<body>

<a href="index.html" class="nav-home">Kembali ke Beranda</a>

<div class="header">
  <div class="header-title">
    PETA INFORMASI PERTANAHAN</div>
  <div class="header-sub">
    KELURAHAN PACARKELING, KECAMATAN TAMBAKSARI</div>
  </div>
</div>

<div class="map-toolbar">
  <button class="tool-btn" data-panel="basemapPanel"><span class="material-icons">map</span></button>
  <button class="tool-btn" data-panel="layerPanel"><span class="material-icons">layers</span></button>
  <button class="tool-btn" data-panel="legendPanel"><span class="material-icons">legend_toggle</span></button>
  <button id="zoomIn" class="tool-btn"><span class="material-icons">add</span></button>
  <button id="zoomOut" class="tool-btn"><span class="material-icons">remove</span></button>
  <button id="measureBtn" class="tool-btn"><span class="material-icons">straighten</span></button>
</div>

<div class="measure-toolbar" id="measureToolbar">
  <button class="measure-btn" id="measureDistance">
    <span class="material-icons">timeline</span>
    Jarak
  </button>
  <button class="measure-btn" id="measureArea">
    <span class="material-icons">crop_square</span>
    Luas
  </button>
  <div class="measure-divider"></div>
  <button class="measure-btn" id="finishMeasure" style="display:none;">
    <span class="material-icons">done</span>
    Selesai
  </button>
  <button class="measure-btn" id="deleteLast" style="display:none;">
    <span class="material-icons">undo</span>
    Hapus Titik
  </button>
  <button class="measure-btn" id="cancelMeasure" style="display:none;">
    <span class="material-icons">close</span>
    Batal
  </button>
  <div class="measure-divider" id="resultDivider" style="display:none;"></div>
  <div class="measure-result" id="measureResult"></div>
  <button class="measure-btn" id="clearAll">
    <span class="material-icons">delete_outline</span>
    Hapus Semua
  </button>
</div>

<div id="basemapPanel" class="panel">
  <b>Basemap</b><br>
  <label><input type="radio" name="basemap" value="osm" checked> OSM</label><br>
  <label><input type="radio" name="basemap" value="carto"> Carto</label><br>
  <label><input type="radio" name="basemap" value="esri"> Esri</label>
</div>

<div id="layerPanel" class="panel">
  <b>Layer</b><br>
  <label><input type="checkbox" id="layerPersil" checked> Persil</label><br>
  <label><input type="checkbox" id="layerBangunan"> Bangunan</label><br>
  <label><input type="checkbox" id="layerJalan"> Jalan</label><br>
  <label><input type="checkbox" id="layerKereta"> Kereta</label><br>
  <label><input type="checkbox" id="layerBatas"> Batas</label>
</div>

<div id="legendPanel" class="panel">
  <b>Legenda</b>
  <div id="legendContent"></div>
</div>

<div class="info-box">
  <b>Informasi Pertanahan</b><br>
  Jumlah Bidang: <b>2014</b><br>
  Total Luas: <b>1.169.334,229 m²</b><br>
  (116,933 ha)
</div>

<div id="map"></div>

<div class="map-footer">
  <div id="coord"></div>
</div>

<div class="north-arrow">
  <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
    <path d="M12 2L15 10H9L12 2Z" fill="#dc3545"/>
    <path d="M12 22L9 14H15L12 22Z" fill="#6c757d"/>
    <circle cx="12" cy="12" r="2" fill="#333"/>
    <text x="12" y="6" text-anchor="middle" font-size="4" font-weight="bold" fill="#fff">N</text>
  </svg>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-geometryutil/0.9.1/leaflet.geometryutil.min.js"></script>

<script>
/* MAP */
const map=L.map('map', {zoomControl: false}).setView([-7.2499,112.7532],15);
L.control.scale({position:'bottomright', imperial: false}).addTo(map);

// Adjust scale control position
setTimeout(() => {
  const scaleControl = document.querySelector('.leaflet-control-scale');
  if (scaleControl) {
    scaleControl.style.marginBottom = '35px';
  }
}, 100);

/* COORD */
map.on('mousemove',e=>{
 document.getElementById('coord').innerText=
  `Lat: ${e.latlng.lat.toFixed(6)} | Lng: ${e.latlng.lng.toFixed(6)}`;
});

/* BASEMAP */
const basemaps={
 osm:L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png'),
 carto:L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png'),
 esri:L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}')
};
basemaps.osm.addTo(map);

/* ZOOM */
zoomIn.onclick=()=>map.zoomIn();
zoomOut.onclick=()=>map.zoomOut();

/* TOGGLE PANEL - FIXED VERSION */
document.querySelectorAll('.tool-btn[data-panel]').forEach(btn=>{
 btn.onclick=()=>{
  const targetPanel = document.getElementById(btn.dataset.panel);
  const isCurrentlyOpen = targetPanel.style.display === 'block';
  
  // Tutup semua panel dan hapus kelas active dari semua tombol
  document.querySelectorAll('.panel').forEach(p => p.style.display = 'none');
  document.querySelectorAll('.tool-btn[data-panel]').forEach(b => b.classList.remove('active'));
  
  // Jika panel sebelumnya tertutup, buka panel ini
  if (!isCurrentlyOpen) {
    targetPanel.style.display = 'block';
    btn.classList.add('active');
  }
 };
});

/* MEASURE */
const drawLayer=new L.FeatureGroup().addTo(map);
let currentDrawing = null;
let measureMode = null;
let measureActive = false;

measureBtn.onclick=()=>{
  const toolbar = document.getElementById('measureToolbar');
  if (!measureActive) {
    toolbar.classList.add('active');
    measureBtn.classList.add('active');
    measureActive = true;
  } else {
    toolbar.classList.remove('active');
    measureBtn.classList.remove('active');
    measureActive = false;
    cancelCurrentMeasure();
  }
};

// Distance measurement
measureDistance.onclick=()=>{
  if (measureMode === 'distance') {
    cancelCurrentMeasure();
    return;
  }
  cancelCurrentMeasure();
  measureMode = 'distance';
  measureDistance.classList.add('active');
  showMeasureControls();
  
  currentDrawing = new L.Draw.Polyline(map, {
    shapeOptions: {
      color: '#3388ff',
      weight: 3
    }
  });
  currentDrawing.enable();
  
  map.on('draw:drawvertex', updateMeasurement);
};

// Area measurement
measureArea.onclick=()=>{
  if (measureMode === 'area') {
    cancelCurrentMeasure();
    return;
  }
  cancelCurrentMeasure();
  measureMode = 'area';
  measureArea.classList.add('active');
  showMeasureControls();
  
  currentDrawing = new L.Draw.Polygon(map, {
    shapeOptions: {
      color: '#3388ff',
      weight: 3,
      fillOpacity: 0.2
    }
  });
  currentDrawing.enable();
  
  map.on('draw:drawvertex', updateMeasurement);
};

// Finish measurement
finishMeasure.onclick=()=>{
  if (currentDrawing) {
    currentDrawing.completeShape();
  }
};

// Delete last point
deleteLast.onclick=()=>{
  if (currentDrawing && currentDrawing._markers && currentDrawing._markers.length > 0) {
    currentDrawing.deleteLastVertex();
    updateMeasurement();
  }
};

// Cancel measurement
cancelMeasure.onclick=()=>{
  cancelCurrentMeasure();
};

// Clear all measurements
clearAll.onclick=()=>{
  drawLayer.clearLayers();
  document.getElementById('measureResult').classList.remove('show');
  document.getElementById('measureResult').textContent = '';
};

// Handle created shapes
map.on(L.Draw.Event.CREATED, e=>{
  const layer = e.layer;
  drawLayer.addLayer(layer);
  
  // Calculate and show result
  let result = '';
  if (measureMode === 'distance') {
    const length = calculateLength(layer.getLatLngs());
    result = `Jarak: ${formatDistance(length)}`;
  } else if (measureMode === 'area') {
    const area = L.GeometryUtil.geodesicArea(layer.getLatLngs()[0]);
    result = `Luas: ${formatArea(area)}`;
  }
  
  document.getElementById('measureResult').textContent = result;
  document.getElementById('measureResult').classList.add('show');
  document.getElementById('resultDivider').style.display = 'block';
  
  // Add popup to layer
  layer.bindPopup(result).openPopup();
  
  cancelCurrentMeasure();
});

function showMeasureControls() {
  document.getElementById('finishMeasure').style.display = 'flex';
  document.getElementById('deleteLast').style.display = 'flex';
  document.getElementById('cancelMeasure').style.display = 'flex';
}

function hideMeasureControls() {
  document.getElementById('finishMeasure').style.display = 'none';
  document.getElementById('deleteLast').style.display = 'none';
  document.getElementById('cancelMeasure').style.display = 'none';
}

function cancelCurrentMeasure() {
  if (currentDrawing) {
    currentDrawing.disable();
    currentDrawing = null;
  }
  map.off('draw:drawvertex', updateMeasurement);
  measureDistance.classList.remove('active');
  measureArea.classList.remove('active');
  measureMode = null;
  hideMeasureControls();
}

function updateMeasurement() {
  if (!currentDrawing || !currentDrawing._markers) return;
  
  const resultDiv = document.getElementById('measureResult');
  const resultDivider = document.getElementById('resultDivider');
  
  if (measureMode === 'distance' && currentDrawing._markers.length > 1) {
    const latlngs = currentDrawing._markers.map(m => m.getLatLng());
    const length = calculateLength(latlngs);
    resultDiv.textContent = `Jarak sementara: ${formatDistance(length)}`;
    resultDiv.classList.add('show');
    resultDivider.style.display = 'block';
  } else if (measureMode === 'area' && currentDrawing._markers.length > 2) {
    const latlngs = currentDrawing._markers.map(m => m.getLatLng());
    const area = L.GeometryUtil.geodesicArea(latlngs);
    resultDiv.textContent = `Luas sementara: ${formatArea(area)}`;
    resultDiv.classList.add('show');
    resultDivider.style.display = 'block';
  }
}

function calculateLength(latlngs) {
  let length = 0;
  for (let i = 0; i < latlngs.length - 1; i++) {
    length += latlngs[i].distanceTo(latlngs[i + 1]);
  }
  return length;
}

function formatDistance(meters) {
  if (meters < 1000) {
    return `${meters.toFixed(2)} m`;
  } else {
    return `${(meters / 1000).toFixed(2)} km`;
  }
}

function formatArea(sqMeters) {
  if (sqMeters < 10000) {
    return `${sqMeters.toFixed(2)} m²`;
  } else {
    return `${(sqMeters / 10000).toFixed(2)} ha`;
  }
}

/* GEOJSON */
const PATH="geojson/";
const palette = [
  "#e6194b", // merah
  "#3cb44b", // hijau
  "#ffe119", // kuning
  "#4363d8", // biru
  "#f58231", // oranye
  "#911eb4", // ungu
  "#46f0f0", // cyan
  "#f032e6", // pink
  "#bcf60c", // lime
  "#fabebe", // pastel merah
  "#008080", // teal
  "#e6beff"  // lavender
];
const jenisIndo={
 building:"Bangunan",
 jalan:"Jalan",
 tanah:"Tanah",
 market_place:"Pasar",
 school:"Sekolah",
 clinic:"Klinik",
 hospital:"Rumah Sakit",
 graveyard:"Pemakaman",
 kindergarten:"Taman Kanak-kanak",
 police:"Kantor Polisi",
 restaurant:"Restoran",
 riverbank:"Sempadan Sungai"
};
let colorMap={},activePersil=null;
function getColor(j){
 if(!colorMap[j]) colorMap[j]=palette[Object.keys(colorMap).length%palette.length];
 return colorMap[j];
}

let persilLayer,bangunanLayer,jalanLayer,keretaLayer,batasLayer;

/* PERSIL */
fetch(PATH+"persil.geojson").then(r=>r.json()).then(data=>{
 persilLayer=L.geoJSON(data,{
  style:f=>({fillColor:getColor(f.properties.JENIS),color:'#333',weight:1,fillOpacity:.7}),
  onEachFeature:(f,l)=>{
   const labelMap = {
     'FID': 'FID',
     'NAMAPEMILI': 'Nama Pemilik',
     'NIB': 'NIB',
     'TAHUN': 'Tahun',
     'LUAS': 'Luas',
     'KECAMATAN': 'Kecamatan',
     'KELURAHAN': 'Kelurahan',
     'TIPEHAK': 'Tipe Hak',
     'PENGGUNAAN': 'Penggunaan',
     'JENIS': 'Jenis',
     'KATEGORI': 'Kategori'
   };
   let html="<b>Informasi Persil</b><hr>";
   for(let k in f.properties) {
     const label = labelMap[k] || k;
     html+=`<b>${label}</b>: ${f.properties[k]}<br>`;
   }
   l.bindPopup(html);
   l.on('click',()=>{
    if(activePersil) persilLayer.resetStyle(activePersil);
    l.setStyle({weight:4,color:'#000'});
    map.fitBounds(l.getBounds());
    activePersil=l;
   });
  }
 }).addTo(map);

 bangunanLayer=L.geoJSON(data,{
  filter:f=>f.properties.JENIS==="building",
  style:{fillColor:"#FF6B6B",color:"#8B0000",weight:2}
 });

 buildLegend(data);
}).catch(err => console.log('Data persil tidak ditemukan (demo mode)'));

/* JALAN */
fetch(PATH+"jalan.geojson").then(r=>r.json()).then(d=>{
 jalanLayer=L.geoJSON(d,{style:{color:'#000',weight:4}});
}).catch(err => console.log('Data jalan tidak ditemukan (demo mode)'));

/* KERETA */
fetch(PATH+"kereta.geojson").then(r=>r.json()).then(d=>{
 keretaLayer=L.geoJSON(d,{style:{color:'blue',weight:3,dashArray:'8,4'}});
}).catch(err => console.log('Data kereta tidak ditemukan (demo mode)'));

/* BATAS */
fetch(PATH+"batas.geojson").then(r=>r.json()).then(d=>{
 batasLayer=L.geoJSON(d,{style:{color:'red',weight:4,fillOpacity:0}});
}).catch(err => console.log('Data batas tidak ditemukan (demo mode)'));

/* TOGGLE LAYER */
layerPersil.onchange=e=>e.target.checked?map.addLayer(persilLayer):map.removeLayer(persilLayer);
layerBangunan.onchange=e=>e.target.checked?map.addLayer(bangunanLayer):map.removeLayer(bangunanLayer);
layerJalan.onchange=e=>e.target.checked?map.addLayer(jalanLayer):map.removeLayer(jalanLayer);
layerKereta.onchange=e=>e.target.checked?map.addLayer(keretaLayer):map.removeLayer(keretaLayer);
layerBatas.onchange=e=>e.target.checked?map.addLayer(batasLayer):map.removeLayer(batasLayer);

/* BASEMAP SWITCH */
document.querySelectorAll('input[name=basemap]').forEach(r=>{
 r.onchange=()=>{
  Object.values(basemaps).forEach(b=>map.removeLayer(b));
  basemaps[r.value].addTo(map);
 };
});

/* LEGENDA */
function buildLegend(data){
 const legend=document.getElementById("legendContent");
 legend.innerHTML="";
 [...new Set(data.features.map(f=>f.properties.JENIS))].forEach(j=>{
  legend.innerHTML+=`
   <div class="legend-item">
    <div class="legend-symbol" style="background:${getColor(j)}"></div>
    ${jenisIndo[j]||j}
   </div>`;
 });
}
</script>

</body>
</html>